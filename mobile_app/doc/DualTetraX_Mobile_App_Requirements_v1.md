# DualTetraX Mobile App 상세 요구사항서
Version: 1.0  
Date: 2025-11-18  

## 1. 개요

### 1.1 목적
본 문서는 DualTetraX 디바이스(ESP32 기반 FW)와 연동되는 모바일 애플리케이션의 상세 요구사항을 정의한다.  
모바일 앱은 Flutter + Clean Architecture를 기반으로 iOS와 Android에서 공통으로 동작하며, DualTetraX와 BLE(Bluetooth Low Energy)로 연동하여 사용 이력 수집, 사용 패턴 분석, 사용 가이드 제공을 목표로 한다.

### 1.2 범위
- 지원 플랫폼: iOS, Android
- 개발 기술: Flutter, Clean Architecture, 필요 시 Native 모듈(Swift, Kotlin/Java)
- 연동 대상: DualTetraX(ESP32 FW, BLE 지원)
- 주요 기능:
  - DualTetraX BLE 연결, 자동 연결, 재연결
  - 디바이스 사용 이력 수집 및 저장
  - 일/주/월 사용 시간 및 패턴 분석 및 시각화
  - 데이터 초기화 기능
  - DualTetraX 사용법 단계별 가이드

### 1.3 참조 문서
- DualTetraX Device FW Requirements (Device_FW_Requirement-V2.md)  
  - PR-FW-F-PWR-xxx: 전원 관련 요구사항
  - PR-FW-F-CAR-xxx: U-Shot, E-Shot, LED 케어 전환
  - PR-FW-F-MOD-xxx: Mode/Level 관련 요구사항
  - PR-FW-F-WRK-xxx: Working/Pause/Standby 관련 요구사항
  - PR-FW-F-CHG-xxx: 충전/배터리 관련 요구사항
  - PR-FW-F-WRN-xxx: Warning 관련 요구사항
  - PR-FW-S-DSP-xxx: Display 상태 표시 요구사항
  - PR-FW-S-SND-xxx: 사운드 요구사항
  - PR-FW-S-LED-xxx: Head LED 요구사항

본 모바일 앱 요구사항은 위 FW 요구사항과 모순되지 않도록 설계하며, 디바이스의 상태 및 사용 이력을 “표현/기록/분석”하는 역할에 집중한다.


## 2. 시스템 개요

### 2.1 플랫폼 및 기술
- **공통 UI 프레임워크**: Flutter
- **아키텍처 패턴**: Clean Architecture
  - Presentation Layer (Flutter UI, ViewModel/Bloc/Cubit 등)
  - Domain Layer (UseCase, Entity)
  - Data Layer (Repository, DataSource: BLE, Local DB 등)
- **네이티브 모듈**
  - iOS: Swift로 BLE, 백그라운드 권한 제어 및 OS 제약 대응
  - Android: Kotlin/Java로 BLE, 권한 및 백그라운드 스캔 대응

### 2.2 반응형 UI 요구사항
- 다양한 해상도(iPhone SE ~ Pro Max, 다양한 Android 단말)에서 레이아웃이 깨지지 않아야 한다.
- 세로 모드(portrait)를 기본으로 지원하며, 추후 필요 시 태블릿/가로 모드 확장을 고려한다.
- 주요 화면 요소는 다음을 포함한다.
  - 상단: 연결 상태, 배터리 상태 등 요약 정보
  - 중간: 일/주/월 그래프 및 사용 요약
  - 하단: 주요 기능 버튼(사용 가이드, 설정, 데이터 초기화 등)

### 2.3 DualTetraX와의 관계
- 모바일 앱은 DualTetraX의 **동작을 제어하는 주체**가 아니라,  
  디바이스 FW에서 정의된 상태/모드/레벨/Warning/배터리 상태를 **조회하고 기록/시각화/안내** 하는 역할을 한다.
- 디바이스 FW의 전원, U/E-Shot 동작, LED 패턴, Warning 등은 FW 요구사항에 따라 결정되며, 앱은 이를 변경하지 않는다.
- 앱은 가능한 범위 내에서 디바이스의 현재 상태(예: U/E-Shot, 모드, 레벨, 배터리, 사용 중 여부)를 표시하고 로그를 남긴다.


## 3. Bluetooth (BLE) 연동 상세 요구사항

### 3.1 BLE 기본 요구사항
1. **BLE 방식**
   - DualTetraX는 BLE Peripheral로 동작한다.
   - 모바일 앱은 BLE Central로 동작하여 DualTetraX를 스캔/연결한다.

2. **디바이스 식별**
   - DualTetraX는 광고(Advertising) 시 다음 규칙의 이름을 사용한다.  
     - 예: `DualTetraX-ABCD` (ABCD = MAC 주소 마지막 2바이트 Hex)
   - 앱은 `DualTetraX-` Prefix를 기준으로 스캔 목록에서 디바이스를 필터링한다.

3. **서비스/Characteristic 구조 (예시 수준 요구사항)**
   - 별도 BLE 프로토콜 문서에서 UUID를 정의하되, 앱 관점에서는 아래 성격의 서비스/특성이 필요하다.
     - Device Info Service
       - Firmware Version, Serial, Model Name
     - Realtime Status Service
       - 현재 Shot 타입(U/E/LED), 모드, 레벨, 배터리 상태, 동작 상태(Working/Pause/Standby), Warning 상태
     - Usage Log/Session Service
       - 사용 세션 시작/종료 이벤트
       - 세션 상세 정보 (Shot, 모드, 레벨, 시간 정보 등)
     - Config/Control Service (선택)
       - 시간 동기화, 일부 설정값 전달 등 (단, FW 요구사항과 충돌하지 않는 범위)

### 3.2 연결 절차 및 UX (연결을 쉽게 하는 방법)

#### 3.2.1 최초 연결(페어링) 플로우
1. 사용자가 앱을 처음 실행하면, 권한 안내를 표시한다.
   - iOS: Bluetooth, Local Network(필요 시), Notification (선택)
   - Android: Bluetooth, 위치(필요 시), Notification (선택)
2. 권한 동의 후, 앱은 `DualTetraX-` Prefix로 광고하는 디바이스를 스캔한다.
3. 스캔 결과가 1개일 경우:
   - 자동으로 해당 디바이스에 연결 시도 후, “연결되었습니다” 토스트/다이얼로그를 표시한다.
4. 스캔 결과가 여러 개일 경우:
   - 리스트로 표시하고 사용자가 하나를 선택하도록 한다.
   - 선택된 디바이스를 “선호 디바이스(Primary Device)”로 저장한다.
5. 최초 연결 성공 시:
   - 디바이스 ID, 이름, BLE 주소를 로컬 DB에 저장한다.
   - 이후 자동 연결 대상이 된다.

#### 3.2.2 재연결 플로우 (자동 연결)
1. 앱이 실행될 때(포그라운드 진입 시), 이전에 저장된 “선호 디바이스” 정보가 있을 경우:
   - 백그라운드 스캔 또는 연결 시도를 수행한다.
   - 해당 디바이스의 광고가 감지될 때 자동으로 연결을 시도한다.
2. 사용자 액션에 의해 앱이 “연결 화면”을 열 경우:
   - 현재 연결 상태를 표시하고, 연결이 끊겨 있으면 재연결 버튼을 제공한다.
3. 디바이스가 전원 On/PWR-On 상태가 되면(광고 송출 시작):
   - 앱이 포그라운드에 있는 경우 자동으로 연결되어야 한다.
   - OS 제약으로 인해 100% 보장은 어렵지만, “자동 연결 시도 중” 표시를 제공한다.

#### 3.2.3 연결 상태 표시
- 상단 또는 헤더 영역에 다음 상태를 명확하게 표시한다.
  - 연결됨(Connected)
  - 연결 시도 중(Connecting…)
  - 연결 끊김(Disconnected)
- 연결 실패/타임아웃 시:
  - 사용자에게 재시도 버튼 제공
  - “디바이스 전원을 켰는지 확인해 주세요” 등의 안내 표시

#### 3.2.4 페어링 및 보안
- 가능한 한 OS 기본 페어링 다이얼로그를 최소화하여 UX를 단순화한다.
- 필요 시 BLE Bonding을 사용하여 재연결 시 인증/페어링 과정을 생략한다.
- 디바이스와 앱 간에 고유 식별자/토큰을 교환하여, 다른 앱이 임의로 연결하는 경우를 방지할 수 있도록 확장 가능성을 고려한다.

### 3.3 자동 연결 및 사용 중 데이터 수집
1. DualTetraX 전원이 켜져서 U/E-Shot Working 상태에 진입했을 때, 앱이 실행 중이라면:
   - 가능한 한 빠르게(예: 몇 초 내) 자동 연결을 시도하고,
   - Working 상태 변경 이벤트를 수신하여 사용 로그를 기록한다.
2. Pause/Standby/Power Off 상태에서는:
   - 불필요한 주기적 데이터 요청을 하지 않고,
   - 필요한 최소 정보(예: 연결 유지용 ping 수준)만 송수신한다.
3. 충전 중 상태(Charging)인 경우:
   - FW 요구사항(PR-FW-F-CHG-001)에 따라 디바이스는 버튼이 동작하지 않으므로,
   - 앱은 충전 상태 표시만 하고 사용 이력 수집은 수행하지 않는다.

### 3.4 전력 최적화 요구사항 (디바이스 배터리 최소 사용)
1. 데이터 전송 정책
   - DualTetraX는 **이벤트 기반**으로 데이터를 전송한다.
     - 예: Working 시작/종료, 모드/레벨 변경, Warning 발생, 배터리 상태 임계점(충분/부족/방전) 변경 시
   - 앱은 **주기적인 폴링(polling) 방식**의 요청을 최소화한다.
2. 연결 유지 정책
   - 장시간(예: 수 분 이상) 디바이스 동작이 없고 Standby/Off 상태일 때:
     - 앱은 연결을 유지하지 않고 자동으로 연결을 해제할 수 있다(설정 옵션으로 조절 가능).
   - 재사용 시에는 위 자동 연결 플로우에 따라 다시 연결한다.
3. BLE 파라미터
   - Connection Interval, Slave Latency 등은 별도 HW/FW 튜닝 범위이나,
   - 앱 요구사항으로 “전력 효율을 위한 Connection Parameter 최적화”가 필요함을 명시한다.

### 3.5 모바일 OS 제약 고려
- iOS의 백그라운드 스캔/연결 제약, Android 12+의 BLE/위치 권한 정책을 고려하여:
  - 앱이 완전히 종료된 상태에서의 자동 연결은 보장하지 않는다.
  - 대신 앱이 포그라운드에 있을 때 “사용 중 자동 연결”을 강하게 지원한다.


## 4. 데이터 모델 및 사용 이력 관리 요구사항

### 4.1 기본 개념 정의
- **사용 세션(Usage Session)**
  - U-Shot, E-Shot, 또는 LED 케어가 실제로 Working 상태에 있었던 구간을 의미한다.
  - 하나의 세션은 다음을 포함한다.
    - 시작 시각, 종료 시각
    - Shot 종류 (U, E, LED)
    - 모드 (GL/TU/RN/VO, CL/FM/LN/LF, LED 모드)
    - Level (1, 2, 3)
    - Working 총 시간 (초/분)
    - Pause 시간, Standby 전환 여부
    - Warning 발생 여부 및 종류
    - 세션 시작/종료 시 배터리 상태(충분/부족/방전 직전 등)

- **사용 패턴(Usage Pattern)**
  - 특정 기간(일/주/월) 동안 Shot/모드/레벨 조합이 어떻게 사용되었는지를 의미한다.
  - 예: 한 달 동안 U-Shot/Glow 모드 Level 2 사용 시간이 가장 길다 등.

### 4.2 데이터 저장 위치
- 앱 내부 로컬 DB (예: SQLite, Hive 등)
- 사용자 단말에 암호화된 형태로 저장(개인 데이터 보호 고려)
- 기본적으로 서버 연동은 고려하지 않으며, 추후 요구사항에 따라 확장 가능

### 4.3 사용 이력 수집 흐름
1. DualTetraX에서 Working 상태 진입 시 BLE 이벤트 송신 (예: `SESSION_START`)
2. 앱은 수신 시점의 시간을 `세션 시작 시간`으로 기록
3. Working 중 모드/레벨 변경, Warning 발생 등 이벤트를 기록
4. Working 종료, Standby 진입, Power Off 등 이벤트 수신 시 `세션 종료 시간`으로 기록
5. 앱은 세션 데이터를 정규화하여 DB에 저장

### 4.4 일/주/월 집계 로직
- **일별 집계**
  - 날짜별 총 사용 시간 (분)
  - Shot별, 모드별, 레벨별 사용 시간
  - Warning 발생 횟수
- **주별 집계**
  - 주간 총 사용 시간
  - 요일별 사용 분포
- **월별 집계**
  - 월간 총 사용 시간
  - 선호 Shot/모드/레벨 통계

앱은 Domain Layer의 UseCase로 위 집계 로직을 구현하고, Presentation Layer에서 이를 그래프로 시각화한다.


## 5. 기능 요구사항

### 5.1 홈/대시보드 화면
1. 연결 상태 표시
   - 현재 연결 디바이스 이름, 연결 상태(Connected/Disconnected/Connecting)
   - 배터리 상태 (충분/부족/방전 경고 등)
2. 오늘의 사용 요약
   - 오늘 사용 시간 (총 분)
   - 오늘 사용한 Shot/모드 상위 1~2개
3. 빠른 진입
   - “사용 가이드 보기” 버튼
   - “일/주/월 사용 기록 보기”로 이동 버튼

### 5.2 일별 사용 그래프 화면
1. X축: 시간대 혹은 하루 내 세션 분포
2. Y축: 사용 시간(분)
3. Shot/모드/레벨에 따른 색상/범례 제공 (예: U/E/LED 구분)
4. 세션 선택 시 상세 정보 팝업
   - 시작/끝 시각
   - Shot, 모드, 레벨
   - 해당 세션에서 Warning 발생 여부

### 5.3 주별 사용 그래프 화면
1. X축: 요일(월~일)
2. Y축: 각 요일별 사용 시간(분)
3. Shot별 더미 stacked bar 혹은 필터링 기능
4. 주별 요약 텍스트
   - 이번 주 평균 하루 사용 시간
   - 지난 주 대비 증감

### 5.4 월별 사용 그래프 화면
1. X축: 날짜 또는 주
2. Y축: 사용 시간
3. 월간 요약
   - 총 사용 시간
   - 가장 많이 사용된 Shot/모드
   - Warning 발생 빈도

### 5.5 데이터 초기화 기능
1. “전체 데이터 초기화” 메뉴 제공 (설정 화면 내)
2. 초기화 대상
   - 앱 내 저장된 모든 사용 이력 및 통계 데이터
   - 저장된 연결된 디바이스 정보(선호 디바이스) 여부는 옵션으로 분리 가능
3. 사용자 확인 절차
   - 1차 경고 다이얼로그: “전체 사용 기록이 삭제됩니다. 계속하시겠습니까?”
   - 2차 확인: “삭제” 버튼을 누르기 위해 특정 문구 입력 또는 체크 박스 선택 등
4. 초기화 완료 후
   - 홈 화면으로 이동
   - “데이터가 초기화되었습니다” 안내 표시

### 5.6 DualTetraX 사용법 단계별 안내 기능
1. 온보딩(처음 앱 실행 시 또는 메뉴에서 다시 보기)
   - 1단계: 디바이스 충전/전원 켜는 법 (PR-FW-F-PWR-001~006에 기반)
   - 2단계: Shot(U/E/LED) 전환 방법 (PR-FW-F-CAR-001~005)
   - 3단계: 모드/레벨 변경 방법 (PR-FW-F-MOD-001~008)
   - 4단계: U-Shot/E-Shot 사용 중 주의사항 (온도/배터리 Warning, Pause/Standby 로직 등)
   - 5단계: 사용 후 전원 Off 및 보관 방법
2. 각 단계는 텍스트 + 아이콘/이미지로 구성
3. 필요 시 “지금 디바이스 상태 보기” 버튼으로 실제 상태(Shot, 모드, 레벨)를 표시하여 현실과 매칭할 수 있게 한다.

### 5.7 설정 화면
- 연결 디바이스 정보 보기 / 변경
- 데이터 초기화
- 알림 설정 (예: 사용 목표 시간 달성 알림, 일정 기간 미사용 알림 – 추후 옵션)
- 앱 버전, 약관, 개인정보 처리방침 등


## 6. 비기능 요구사항

### 6.1 성능
- 일반적인 시나리오에서 BLE 연결 시도 후 수 초 내에 연결되는 것을 목표로 한다. (실장 시 HW/환경에 따라 달라질 수 있음)
- 일/주/월 데이터 조회 시, 1초 이내에 그래프를 표시하는 것을 목표로 한다.

### 6.2 오프라인 동작
- 디바이스가 없어도 과거 사용 이력 및 그래프를 조회할 수 있어야 한다.
- BLE 연결이 실패해도 앱 기능의 대부분(과거 기록 보기, 가이드 등)은 정상 동작해야 한다.

### 6.3 안정성
- BLE 연결 실패, 타임아웃, 권한 미부여 등 예외 상황에 대해 명확한 메시지와 안내를 제공한다.
- 앱 비정상 종료 시에도 데이터 손실을 최소화하도록 트랜잭션/저장 로직을 설계한다.

### 6.4 보안 및 개인정보
- 사용 이력 데이터는 앱 내부에만 저장되며, 외부 서버로 전송하지 않는다(추후 요구 시 확장).
- OS가 제공하는 저장소 암호화/보안 메커니즘을 활용한다.


## 7. DualTetraX FW 요구사항과의 정합성 분석

### 7.1 일치하는 주요 포인트
- 전원 상태, U/E-Shot/LED, 모드, 레벨, Working/Pause/Standby, 배터리, Warning 등은  
  모두 FW 요구사항에 정의되어 있으며, 앱은 이를 **표시/기록/분석**만 한다.
- 앱 요구사항은 디바이스 동작 로직(U-Shot/E-Shot의 세부 주파수, 온도 기준, 타이머 등)을 변경하지 않는다.
- FW의 상태 정의(PR-FW-F-WRK-xxx, PR-FW-S-DSP-xxx 등)를 그대로 사용자가 이해하기 쉬운 형태로 재가공하여 보여주는 역할을 한다.

### 7.2 추가로 가정한 부분 (FW 확장 필요 가능성)
- BLE 서비스/Characteristic 구조 및 이벤트 프로토콜은 기존 FW 요구사항 문서에 정의되어 있지 않으므로,
  앱에서 요구하는 “세션 시작/종료/상태 변화 이벤트”를 제공하기 위해서는 별도의 BLE 인터페이스 정의가 필요하다.
- 사용 이력(Usage Session)을 정확히 계산하기 위해서는:
  - Working 상태 진입/탈출 이벤트
  - 모드/레벨 변경 이벤트
  - Warning 발생 이벤트
  등이 BLE를 통해 앱으로 전달되어야 한다.
- 위 가정은 FW 동작을 변경하는 것이 아니라, 이미 존재하는 상태 변화를 **외부로 노출**하는 수준이며, 기존 요구사항과 모순되지 않는다.

### 7.3 충돌 위험이 없는지에 대한 확인
- 앱은 디바이스 전원 On/Off를 강제하지 않는다. (사용자는 디바이스의 물리 버튼으로 제어)
- 앱은 디바이스의 Shot/모드/레벨을 직접 변경하는 기능을 가지지 않거나,  
  가진다 하더라도 FW가 허용하는 범위 내에서만 동작하도록 이후 인터페이스 정의 시 제한할 수 있다.
- 충전 중에는 FW에서 버튼이 무력화되므로, 앱은 단지 “충전 중” 상태를 표시하는 데 그친다.

결론적으로, 본 모바일 앱 요구사항은 현 시점의 DualTetraX FW 요구사항과 **기능적으로 충돌하지 않으며**,  
FW에 BLE 인터페이스(상태 이벤트 노출)를 추가하는 전제를 두고 있다.


## 8. 요약

- Flutter + Clean Architecture 기반으로 iOS/Android를 동시에 지원하는 DualTetraX 전용 모바일 앱 요구사항을 정의하였다.
- 앱은 반응형 UI, BLE 자동 연결, 사용 이력 및 패턴 분석, 데이터 초기화, 단계별 사용 가이드를 제공한다.
- BLE는 디바이스 이름 규칙, 자동 연결, 이벤트 기반 데이터 전송을 통해 **사용 편의성과 디바이스 배터리 효율**을 모두 고려하였다.
- 생성된 요구사항은 DualTetraX FW 요구사항과 모순되지 않으며, FW에서 BLE 상태 이벤트를 노출한다는 전제하에 정합성을 가진다.
